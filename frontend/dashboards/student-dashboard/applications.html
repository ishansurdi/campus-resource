<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Applications | CAMPUSPHERE</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="../../auth.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --stone-50: #faf9f6;
            --stone-100: #f1f0ec;
            --stone-200: #e5e3da;
            --charcoal: #1a1c1e;
            --muted-blue: #2d4a63;
            --accent-gold: #c5a059;
            --accent-teal: #3d706e;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--stone-50);
            color: var(--charcoal);
        }
        h1, h2, h3 { font-family: 'Inter', sans-serif; letter-spacing: -0.02em; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--stone-50); }
        ::-webkit-scrollbar-thumb { background: var(--stone-200); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--muted-blue); }

        .sidebar-link {
            transition: all 0.2s ease;
        }
        .sidebar-link:hover {
            transform: translateX(4px);
        }
        .sidebar-link.active {
            background-color: var(--stone-100);
            border-left: 3px solid var(--muted-blue);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
        }
    </style>
</head>
<body class="antialiased bg-[#faf9f6]">

    <div class="flex min-h-screen">
        
        <!-- Sidebar -->
        <aside class="w-72 bg-white border-r border-[#e5e3da] fixed h-full overflow-y-auto">
            <!-- Logo -->
            <div class="p-8 border-b border-[#e5e3da]">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-8 h-8 bg-[#1a1c1e] flex items-center justify-center rounded-sm">
                        <div class="w-4 h-4 border-2 border-[#c5a059] rotate-45"></div>
                    </div>
                    <span class="text-lg font-bold tracking-[0.15em] text-[#1a1c1e]">CAMPUSPHERE</span>
                </div>
                <div class="flex items-center gap-3 p-3 bg-[#faf9f6] rounded-sm">
                    <div id="userInitials" class="w-10 h-10 rounded-full bg-[#2d4a63] flex items-center justify-center text-white font-bold text-sm">
                        ST
                    </div>
                    <div>
                        <div id="userName" class="text-[11px] font-bold text-[#1a1c1e]">Loading...</div>
                        <div class="text-[9px] text-slate-400 uppercase tracking-widest">Student Portal</div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="p-6">
                <div class="mb-8">
                    <div class="text-[9px] font-bold uppercase tracking-[0.3em] text-slate-400 mb-4 px-3">Main Menu</div>
                    <ul class="space-y-1">
                        <li>
                            <a href="student-dashboard.html" class="sidebar-link flex items-center gap-3 px-3 py-3 text-[12px] font-bold uppercase tracking-widest text-slate-500 hover:text-[#1a1c1e] rounded-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                                Dashboard
                            </a>
                        </li>
                        <li>
                            <a href="profile.html" class="sidebar-link flex items-center gap-3 px-3 py-3 text-[12px] font-bold uppercase tracking-widest text-slate-500 hover:text-[#1a1c1e] rounded-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                My Profile
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="mb-8">
                    <div class="text-[9px] font-bold uppercase tracking-[0.3em] text-slate-400 mb-4 px-3">Activities</div>
                    <ul class="space-y-1">
                        <li>
                            <a href="clubs.html" class="sidebar-link flex items-center gap-3 px-3 py-3 text-[12px] font-bold uppercase tracking-widest text-slate-500 hover:text-[#1a1c1e] rounded-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                Clubs
                            </a>
                        </li>
                        <li>
                            <a href="events.html" class="sidebar-link flex items-center gap-3 px-3 py-3 text-[12px] font-bold uppercase tracking-widest text-slate-500 hover:text-[#1a1c1e] rounded-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                Events
                            </a>
                        </li>
                        <li>
                            <a href="applications.html" class="sidebar-link active flex items-center gap-3 px-3 py-3 text-[12px] font-bold uppercase tracking-widest text-[#1a1c1e] rounded-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                Applications
                            </a>
                        </li>
                    </ul>
                </div>

                <div>
                    <div class="text-[9px] font-bold uppercase tracking-[0.3em] text-slate-400 mb-4 px-3">System</div>
                    <ul class="space-y-1">
                        <li>
                            <a href="#logout" onclick="handleLogout(); return false;" class="sidebar-link flex items-center gap-3 px-3 py-3 text-[12px] font-bold uppercase tracking-widest text-red-500 hover:text-red-600 rounded-sm cursor-pointer">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="ml-72 flex-1 p-12">
            
            <!-- Header -->
            <header class="mb-12">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h1 class="text-4xl font-bold text-[#1a1c1e] mb-2">Club Applications</h1>
                        <p class="text-sm text-slate-500 uppercase tracking-widest">Submit and track your club-related requests</p>
                    </div>
                    <button onclick="openApplicationModal()" class="px-6 py-3 bg-[#2d4a63] text-white rounded-sm text-[11px] font-bold uppercase tracking-widest hover:bg-[#1a1c1e] transition-colors">
                        + New Application
                    </button>
                </div>

                <!-- Active Club Info -->
                <div id="activeClubBanner" style="display: none;" class="mb-8 p-4 bg-blue-50 border border-blue-200 rounded-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-xs font-bold uppercase tracking-widest text-blue-600 mb-1">Active Club Session</div>
                            <div class="text-sm font-bold text-[#1a1c1e]">
                                <span id="activeClubNameBanner"></span> - <span id="activeClubRoleBanner" class="text-blue-600"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Application Stats -->
                <div class="grid grid-cols-4 gap-6 mb-8">
                    <div class="bg-white border border-[#e5e3da] rounded-sm p-6">
                        <div class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-2">Total Applications</div>
                        <div id="statTotal" class="text-3xl font-bold text-[#1a1c1e]">0</div>
                    </div>
                    <div class="bg-white border border-[#e5e3da] rounded-sm p-6">
                        <div class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-2">Pending Review</div>
                        <div id="statPending" class="text-3xl font-bold text-[#c5a059]">0</div>
                    </div>
                    <div class="bg-white border border-[#e5e3da] rounded-sm p-6">
                        <div class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-2">Approved</div>
                        <div id="statApproved" class="text-3xl font-bold text-[#3d706e]">0</div>
                    </div>
                    <div class="bg-white border border-[#e5e3da] rounded-sm p-6">
                        <div class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-2">Rejected</div>
                        <div id="statRejected" class="text-3xl font-bold text-red-600">0</div>
                    </div>
                </div>
            </header>

            <!-- Applications List -->
            <section class="bg-white border border-[#e5e3da] rounded-sm p-8">
                <h2 class="text-xl font-bold text-[#1a1c1e] uppercase tracking-widest text-[12px] mb-6">My Applications</h2>
                
                <div id="applicationsList">
                    <div class="text-center py-12 text-slate-400">Loading applications...</div>
                </div>
            </section>
        </main>
    </div>

    <!-- New Application Modal -->
    <div id="applicationModal" class="modal items-center justify-center p-4">
        <div class="bg-white rounded-sm max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-[#e5e3da] p-6 flex items-center justify-between">
                <h3 class="text-xl font-bold text-[#1a1c1e] uppercase tracking-widest text-[12px]">New Application</h3>
                <button onclick="closeApplicationModal()" class="text-slate-400 hover:text-[#1a1c1e]">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <form id="applicationForm" class="p-6 space-y-6">
                <div>
                    <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-2">Application Type*</label>
                    <select id="applicationType" required class="w-full p-3 border border-[#e5e3da] rounded-sm text-sm focus:outline-none focus:border-[#2d4a63]">
                        <option value="">Select Type</option>
                        <option value="member_addition">Member Addition</option>
                        <option value="member_removal">Member Removal</option>
                        <option value="position_change">Position Change</option>
                        <option value="budget_request">Budget Request</option>
                        <option value="club_info_update">Club Information Update</option>
                        <option value="resource_request">Resource Request</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div>
                    <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-2">Title</label>
                    <input type="text" id="applicationTitle" class="w-full p-3 border border-[#e5e3da] rounded-sm text-sm focus:outline-none focus:border-[#2d4a63]" placeholder="Brief title for your application">
                </div>

                <div>
                    <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-2">Description</label>
                    <textarea id="applicationDescription" rows="4" class="w-full p-3 border border-[#e5e3da] rounded-sm text-sm focus:outline-none focus:border-[#2d4a63]" placeholder="Detailed description of your request"></textarea>
                </div>

                <div>
                    <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-2">Justification*</label>
                    <textarea id="applicationJustification" rows="4" required class="w-full p-3 border border-[#e5e3da] rounded-sm text-sm focus:outline-none focus:border-[#2d4a63]" placeholder="Explain why this request is needed"></textarea>
                </div>

                <div class="flex gap-4 pt-4 border-t border-[#e5e3da]">
                    <button type="button" onclick="closeApplicationModal()" class="flex-1 px-6 py-3 border border-[#e5e3da] text-[#1a1c1e] rounded-sm text-[11px] font-bold uppercase tracking-widest hover:bg-[#f1f0ec] transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-6 py-3 bg-[#2d4a63] text-white rounded-sm text-[11px] font-bold uppercase tracking-widest hover:bg-[#1a1c1e] transition-colors">
                        Submit Application
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentClubId = null;

        document.addEventListener('DOMContentLoaded', function() {
            if (!protectPage('student')) {
                return;
            }
            
            loadUserInfo();
            loadApplications();
        });

        async function loadUserInfo() {
            const user = getCurrentUser();
            
            const activeClubName = localStorage.getItem('active_club_name');
            const activeClubRole = localStorage.getItem('active_club_role');
            currentClubId = localStorage.getItem('active_club_id');
            
            if (activeClubName) {
                document.getElementById('activeClubBanner').style.display = 'block';
                document.getElementById('activeClubNameBanner').textContent = activeClubName;
                document.getElementById('activeClubRoleBanner').textContent = activeClubRole || 'Member';
            }
            
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('http://localhost:8000/api/auth/profile/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    const fullName = userData.first_name && userData.last_name 
                        ? `${userData.first_name} ${userData.last_name}` 
                        : userData.username;
                    
                    const initials = userData.first_name && userData.last_name
                        ? `${userData.first_name.charAt(0)}${userData.last_name.charAt(0)}`
                        : userData.username.substring(0, 2).toUpperCase();
                    
                    document.getElementById('userInitials').textContent = initials;
                    document.getElementById('userName').textContent = fullName;
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        async function loadApplications() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('http://localhost:8000/api/auth/club-applications/my/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const applications = await response.json();
                    displayApplications(applications);
                    updateStats(applications);
                } else {
                    document.getElementById('applicationsList').innerHTML = '<div class="text-center py-12 text-red-500">Failed to load applications</div>';
                }
            } catch (error) {
                console.error('Error loading applications:', error);
                document.getElementById('applicationsList').innerHTML = '<div class="text-center py-12 text-red-500">Error loading applications</div>';
            }
        }

        function updateStats(applications) {
            const total = applications.length;
            const pending = applications.filter(app => app.status === 'pending_faculty' || app.status === 'pending_admin').length;
            const approved = applications.filter(app => app.status === 'approved' || app.status === 'implemented').length;
            const rejected = applications.filter(app => app.status === 'faculty_rejected' || app.status === 'admin_rejected').length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPending').textContent = pending;
            document.getElementById('statApproved').textContent = approved;
            document.getElementById('statRejected').textContent = rejected;
        }

        function displayApplications(applications) {
            const container = document.getElementById('applicationsList');
            
            if (applications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p class="text-slate-400 mb-4">No applications submitted yet</p>
                        <button onclick="openApplicationModal()" class="px-6 py-2 bg-[#2d4a63] text-white rounded-sm text-xs font-bold uppercase tracking-widest hover:bg-[#1a1c1e]">
                            Submit Your First Application
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="space-y-4">
                    ${applications.map(app => `
                        <div class="border border-[#e5e3da] rounded-sm p-6 hover:border-[#2d4a63] transition-colors">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="text-xs font-mono text-slate-500">${app.application_id}</span>
                                        ${getStatusBadge(app.status)}
                                    </div>
                                    <h3 class="text-lg font-bold text-[#1a1c1e] mb-1">${app.title || getApplicationTypeLabel(app.application_type)}</h3>
                                    <p class="text-sm text-slate-500">${app.club_name} â€¢ Submitted ${formatDate(app.created_at)}</p>
                                </div>
                            </div>
                            
                            ${app.description ? `<p class="text-sm text-slate-600 mb-4">${app.description}</p>` : ''}
                            
                            <!-- Approval Timeline -->
                            <div class="flex items-center gap-2 mb-4">
                                ${getTimelineSteps(app.status)}
                            </div>
                            
                            ${app.faculty_rejection_reason ? `
                                <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-sm">
                                    <div class="text-xs font-bold uppercase tracking-widest text-red-600 mb-1">Faculty Rejection Reason</div>
                                    <p class="text-sm text-red-700">${app.faculty_rejection_reason}</p>
                                </div>
                            ` : ''}
                            
                            ${app.admin_rejection_reason ? `
                                <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-sm">
                                    <div class="text-xs font-bold uppercase tracking-widest text-red-600 mb-1">Admin Rejection Reason</div>
                                    <p class="text-sm text-red-700">${app.admin_rejection_reason}</p>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getStatusBadge(status) {
            const statusConfig = {
                'pending_faculty': { label: 'Pending Faculty', color: 'yellow' },
                'pending_admin': { label: 'Pending Admin', color: 'blue' },
                'faculty_approved': { label: 'Faculty Approved', color: 'green' },
                'faculty_rejected': { label: 'Faculty Rejected', color: 'red' },
                'admin_approved': { label: 'Admin Approved', color: 'green' },
                'admin_rejected': { label: 'Admin Rejected', color: 'red' },
                'approved': { label: 'Approved', color: 'green' },
                'implemented': { label: 'Implemented', color: 'green' },
                'cancelled': { label: 'Cancelled', color: 'gray' }
            };

            const config = statusConfig[status] || { label: status, color: 'gray' };
            const colorClasses = {
                'yellow': 'bg-yellow-100 text-yellow-700',
                'blue': 'bg-blue-100 text-blue-700',
                'green': 'bg-green-100 text-green-700',
                'red': 'bg-red-100 text-red-700',
                'gray': 'bg-gray-100 text-gray-700'
            };

            return `<span class="px-3 py-1 rounded-sm text-xs font-bold uppercase tracking-widest ${colorClasses[config.color]}">${config.label}</span>`;
        }

        function getTimelineSteps(status) {
            const steps = [
                { key: 'faculty', label: 'Faculty Review' },
                { key: 'admin', label: 'Admin Review' },
                { key: 'approved', label: 'Approved' }
            ];

            const statusProgress = {
                'pending_faculty': 0,
                'faculty_approved': 1,
                'pending_admin': 1,
                'admin_approved': 2,
                'approved': 3,
                'implemented': 3,
                'faculty_rejected': -1,
                'admin_rejected': -2
            };

            const progress = statusProgress[status] || 0;

            return steps.map((step, index) => {
                let stepClass = 'bg-gray-200 text-gray-400';
                if (index < progress) {
                    stepClass = 'bg-green-500 text-white';
                } else if (index === progress && progress >= 0) {
                    stepClass = 'bg-blue-500 text-white';
                }

                return `
                    <div class="flex items-center ${index < steps.length - 1 ? 'flex-1' : ''}">
                        <div class="${stepClass} px-3 py-1 rounded-sm text-[10px] font-bold uppercase tracking-widest whitespace-nowrap">
                            ${step.label}
                        </div>
                        ${index < steps.length - 1 ? '<div class="flex-1 h-0.5 bg-gray-200 mx-2"></div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function getApplicationTypeLabel(type) {
            const labels = {
                'member_addition': 'Member Addition',
                'member_removal': 'Member Removal',
                'position_change': 'Position Change',
                'budget_request': 'Budget Request',
                'club_info_update': 'Club Information Update',
                'resource_request': 'Resource Request',
                'other': 'Other Request'
            };
            return labels[type] || type;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function openApplicationModal() {
            if (!currentClubId) {
                alert('Please select an active club before submitting an application.');
                return;
            }
            document.getElementById('applicationModal').classList.add('active');
        }

        function closeApplicationModal() {
            document.getElementById('applicationModal').classList.remove('active');
            document.getElementById('applicationForm').reset();
        }

        document.getElementById('applicationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentClubId) {
                alert('No active club selected');
                return;
            }

            const formData = {
                club_id: parseInt(currentClubId),
                application_type: document.getElementById('applicationType').value,
                title: document.getElementById('applicationTitle').value,
                description: document.getElementById('applicationDescription').value,
                justification: document.getElementById('applicationJustification').value,
                application_data: {}
            };

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('http://localhost:8000/api/auth/club-applications/submit/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`Application submitted successfully! ID: ${result.application_id}`);
                    closeApplicationModal();
                    loadApplications();
                } else {
                    // Handle error response
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        alert(`Error: ${error.error || 'Failed to submit application'}`);
                    } else {
                        const errorText = await response.text();
                        console.error('Server returned HTML error:', errorText.substring(0, 500));
                        alert(`Server Error (${response.status}): Please restart the Django server.\nRun: Ctrl+C then 'python manage.py runserver'`);
                    }
                }
            } catch (error) {
                console.error('Error submitting application:', error);
                alert('Error submitting application: ' + error.message);
            }
        });

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                logout();
            }
        }
    </script>
</body>
</html>
