<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Ledger | CAMPUSPHERE</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="../../auth.js"></script>
</head>
<body class="bg-[#f1f0ec] font-sans antialiased">
    <!-- Header -->
    <header class="bg-[#1a1c1e] text-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="goBack()" class="text-white hover:text-[#c5a059] transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h1 class="text-xl font-bold tracking-widest">CAMPUSPHERE</h1>
                </div>
                <div id="userName" class="font-bold text-sm"></div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Event Details Card -->
        <div id="eventDetails" class="bg-white border border-[#e5e3da] rounded-sm p-6 mb-6">
            <!-- Will be populated by JS -->
        </div>

        <!-- Budget Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white border border-[#e5e3da] rounded-sm p-4">
                <div class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-2">Estimated Budget</div>
                <div id="estimatedBudget" class="text-2xl font-bold text-[#1a1c1e]">₹0</div>
            </div>
            <div class="bg-white border border-[#e5e3da] rounded-sm p-4">
                <div class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-2">Approved Budget</div>
                <div id="approvedBudget" class="text-2xl font-bold text-blue-600">₹0</div>
            </div>
            <div class="bg-white border border-[#e5e3da] rounded-sm p-4">
                <div class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-2">Total Expenses</div>
                <div id="totalExpenses" class="text-2xl font-bold text-orange-600">₹0</div>
            </div>
            <div class="bg-white border border-[#e5e3da] rounded-sm p-4">
                <div class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-2">Remaining Budget</div>
                <div id="remainingBudget" class="text-2xl font-bold text-green-600">₹0</div>
                <div id="budgetPercentage" class="text-xs text-slate-500 mt-1">0% used</div>
            </div>
        </div>

        <!-- Budget Bar -->
        <div class="bg-white border border-[#e5e3da] rounded-sm p-4 mb-6">
            <div class="flex items-center justify-between text-xs mb-2">
                <span class="font-bold text-slate-600">Budget Utilization</span>
                <span id="utilizationText" class="font-bold">₹0 / ₹0</span>
            </div>
            <div class="w-full h-6 bg-slate-200 rounded-sm overflow-hidden">
                <div id="budgetBar" class="h-full transition-all duration-500 flex items-center justify-center text-white text-xs font-bold" style="width: 0%"></div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white border border-[#e5e3da] rounded-sm mb-6">
            <div class="flex border-b border-[#e5e3da]">
                <button onclick="switchTab('ledger')" id="ledgerTab" class="flex-1 px-6 py-3 text-sm font-bold uppercase tracking-widest transition-colors border-b-2 border-[#2d4a63] text-[#2d4a63]">
                    Expense Ledger
                </button>
                <button onclick="switchTab('add')" id="addTab" class="flex-1 px-6 py-3 text-sm font-bold uppercase tracking-widest text-slate-500 hover:text-[#2d4a63] transition-colors">
                    Add Expense
                </button>
            </div>

            <!-- Ledger Tab -->
            <div id="ledgerContent" class="p-6">
                <div class="mb-4 flex items-center justify-between">
                    <h2 class="text-lg font-bold text-[#1a1c1e]">Expense Records</h2>
                    <div class="flex gap-2">
                        <select id="statusFilter" onchange="applyFilters()" class="px-3 py-2 text-xs border border-[#e5e3da] rounded-sm font-bold">
                            <option value="">All Status</option>
                            <option value="draft">Draft</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="paid">Paid</option>
                            <option value="reimbursed">Reimbursed</option>
                        </select>
                        <select id="categoryFilter" onchange="applyFilters()" class="px-3 py-2 text-xs border border-[#e5e3da] rounded-sm font-bold">
                            <option value="">All Categories</option>
                            <option value="venue">Venue Rental</option>
                            <option value="equipment">Equipment</option>
                            <option value="catering">Catering</option>
                            <option value="decoration">Decoration</option>
                            <option value="printing">Printing & Stationery</option>
                            <option value="prizes">Prizes & Awards</option>
                            <option value="travel">Travel & Transportation</option>
                            <option value="marketing">Marketing & Promotion</option>
                            <option value="speakers">Guest Speakers / Performers</option>
                            <option value="miscellaneous">Miscellaneous</option>
                        </select>
                    </div>
                </div>

                <div id="expensesList" class="space-y-4">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <!-- Add Expense Tab -->
            <div id="addContent" class="p-6 hidden">
                <h2 class="text-lg font-bold text-[#1a1c1e] mb-6">Add New Expense</h2>
                <form id="expenseForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-widest mb-2">Category*</label>
                            <select id="category" required class="w-full px-4 py-2 border border-[#e5e3da] rounded-sm text-sm">
                                <option value="">Select category</option>
                                <option value="venue">Venue Rental</option>
                                <option value="equipment">Equipment</option>
                                <option value="catering">Catering</option>
                                <option value="decoration">Decoration</option>
                                <option value="printing">Printing & Stationery</option>
                                <option value="prizes">Prizes & Awards</option>
                                <option value="travel">Travel & Transportation</option>
                                <option value="marketing">Marketing & Promotion</option>
                                <option value="speakers">Guest Speakers / Performers</option>
                                <option value="miscellaneous">Miscellaneous</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-widest mb-2">Title*</label>
                            <input type="text" id="title" required class="w-full px-4 py-2 border border-[#e5e3da] rounded-sm text-sm">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-widest mb-2">Description*</label>
                            <textarea id="description" required rows="3" class="w-full px-4 py-2 border border-[#e5e3da] rounded-sm text-sm"></textarea>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-widest mb-2">Amount (₹)*</label>
                            <input type="number" id="amount" required step="0.01" min="0" onchange="calculateTotal()" class="w-full px-4 py-2 border border-[#e5e3da] rounded-sm text-sm">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-widest mb-2">GST Amount (₹)</label>
                            <input type="number" id="gstAmount" step="0.01" min="0" value="0" onchange="calculateTotal()" class="w-full px-4 py-2 border border-[#e5e3da] rounded-sm text-sm">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-widest mb-2">Total Amount (₹)*</label>
                            <input type="number" id="totalAmount" required step="0.01" min="0" readonly class="w-full px-4 py-2 border border-[#e5e3da] rounded-sm text-sm bg-slate-100">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-widest mb-2">Paid To*</label>
                            <input type="text" id="paidTo" required class="w-full px-4 py-2 border border-[#e5e3da] rounded-sm text-sm">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-widest mb-2">Contact Number</label>
                            <input type="text" id="paidToContact" class="w-full px-4 py-2 border border-[#e5e3da] rounded-sm text-sm">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-widest mb-2">Payment Mode</label>
                            <select id="paymentMode" class="w-full px-4 py-2 border border-[#e5e3da] rounded-sm text-sm">
                                <option value="">Select mode</option>
                                <option value="cash">Cash</option>
                                <option value="cheque">Cheque</option>
                                <option value="online">Online Transfer</option>
                                <option value="card">Card Payment</option>
                                <option value="upi">UPI</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-widest mb-2">Payment Reference</label>
                            <input type="text" id="paymentReference" class="w-full px-4 py-2 border border-[#e5e3da] rounded-sm text-sm">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-widest mb-2">Payment Date</label>
                            <input type="date" id="paymentDate" class="w-full px-4 py-2 border border-[#e5e3da] rounded-sm text-sm">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-widest mb-2">Invoice Number</label>
                            <input type="text" id="invoiceNumber" class="w-full px-4 py-2 border border-[#e5e3da] rounded-sm text-sm">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-widest mb-2">Invoice Date</label>
                            <input type="date" id="invoiceDate" class="w-full px-4 py-2 border border-[#e5e3da] rounded-sm text-sm">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-widest mb-2">Notes</label>
                            <textarea id="notes" rows="2" class="w-full px-4 py-2 border border-[#e5e3da] rounded-sm text-sm"></textarea>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button type="submit" class="px-6 py-3 bg-[#2d4a63] text-white text-xs font-bold uppercase tracking-widest rounded-sm hover:bg-[#1a1c1e] transition-colors">
                            Save Expense
                        </button>
                        <button type="button" onclick="switchTab('ledger')" class="px-6 py-3 bg-slate-200 text-slate-700 text-xs font-bold uppercase tracking-widest rounded-sm hover:bg-slate-300 transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        let eventId = null;
        let eventData = null;
        let expenses = [];
        let allExpenses = [];

        document.addEventListener('DOMContentLoaded', function() {
            if (!protectPage('student')) {
                return;
            }

            // Get event ID from URL
            const params = new URLSearchParams(window.location.search);
            eventId = params.get('id');
            
            if (!eventId) {
                alert('No event specified');
                goBack();
                return;
            }

            loadUserInfo();
            loadEventDetails();
            loadExpenses();
        });

        function goBack() {
            window.location.href = 'events.html';
        }

        async function loadUserInfo() {
            const user = getCurrentUser();
            if (user) {
                document.getElementById('userName').textContent = user.first_name && user.last_name 
                    ? `${user.first_name} ${user.last_name}` 
                    : user.username;
            }
        }

        async function loadEventDetails() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`http://localhost:8000/api/auth/events/${eventId}/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    eventData = await response.json();
                    displayEventDetails();
                    updateBudgetOverview();
                } else {
                    alert('Failed to load event details');
                    goBack();
                }
            } catch (error) {
                console.error('Error loading event:', error);
                alert('Error loading event details');
                goBack();
            }
        }

        function displayEventDetails() {
            const startDate = new Date(eventData.start_date);
            const endDate = new Date(eventData.end_date);
            
            document.getElementById('eventDetails').innerHTML = `
                <div class="flex items-start gap-6">
                    ${eventData.poster_url ? `
                        <img src="${eventData.poster_url}" class="w-32 h-32 object-cover rounded-sm">
                    ` : `
                        <div class="w-32 h-32 bg-gradient-to-br from-[#2d4a63] to-[#3d706e] rounded-sm flex items-center justify-center">
                            <div class="text-white text-3xl font-bold">${eventData.title.substring(0, 2).toUpperCase()}</div>
                        </div>
                    `}
                    <div class="flex-1">
                        <h1 class="text-2xl font-bold text-[#1a1c1e] mb-2">${eventData.title}</h1>
                        <div class="flex flex-wrap gap-2 mb-3">
                            <span class="text-xs font-bold uppercase tracking-widest bg-green-100 text-green-700 px-3 py-1 rounded-sm">
                                ${eventData.status}
                            </span>
                            <span class="text-xs font-bold uppercase tracking-widest bg-blue-100 text-blue-700 px-3 py-1 rounded-sm">
                                ${eventData.event_id}
                            </span>
                        </div>
                        <p class="text-sm text-slate-600 mb-4">${eventData.description}</p>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="font-bold text-slate-500">Club:</span> ${eventData.primary_club.name}
                            </div>
                            <div>
                                <span class="font-bold text-slate-500">Venue:</span> ${eventData.venue}
                            </div>
                            <div>
                                <span class="font-bold text-slate-500">Start Date:</span> ${formatDate(startDate)}
                            </div>
                            <div>
                                <span class="font-bold text-slate-500">End Date:</span> ${formatDate(endDate)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateBudgetOverview() {
            const estimated = parseFloat(eventData.estimated_budget) || 0;
            const approved = parseFloat(eventData.approved_budget) || 0;
            const spent = expenses.reduce((sum, exp) => {
                if (exp.status === 'approved' || exp.status === 'paid' || exp.status === 'reimbursed') {
                    return sum + parseFloat(exp.total_amount);
                }
                return sum;
            }, 0);
            const remaining = approved - spent;
            const percentage = approved > 0 ? (spent / approved * 100).toFixed(1) : 0;

            document.getElementById('estimatedBudget').textContent = `₹${estimated.toLocaleString()}`;
            document.getElementById('approvedBudget').textContent = `₹${approved.toLocaleString()}`;
            document.getElementById('totalExpenses').textContent = `₹${spent.toLocaleString()}`;
            document.getElementById('remainingBudget').textContent = `₹${remaining.toLocaleString()}`;
            document.getElementById('budgetPercentage').textContent = `${percentage}% used`;
            document.getElementById('utilizationText').textContent = `₹${spent.toLocaleString()} / ₹${approved.toLocaleString()}`;

            const budgetBar = document.getElementById('budgetBar');
            budgetBar.style.width = `${Math.min(percentage, 100)}%`;
            
            if (percentage >= 90) {
                budgetBar.className = 'h-full transition-all duration-500 flex items-center justify-center text-white text-xs font-bold bg-red-600';
                budgetBar.textContent = `${percentage}% - CRITICAL`;
            } else if (percentage >= 70) {
                budgetBar.className = 'h-full transition-all duration-500 flex items-center justify-center text-white text-xs font-bold bg-yellow-600';
                budgetBar.textContent = `${percentage}% - WARNING`;
            } else {
                budgetBar.className = 'h-full transition-all duration-500 flex items-center justify-center text-white text-xs font-bold bg-green-600';
                budgetBar.textContent = `${percentage}%`;
            }
        }

        async function loadExpenses() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`http://localhost:8000/api/auth/events/${eventId}/expenses/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    allExpenses = await response.json();
                    expenses = allExpenses;
                    displayExpenses();
                    updateBudgetOverview();
                }
            } catch (error) {
                console.error('Error loading expenses:', error);
            }
        }

        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;

            expenses = allExpenses.filter(exp => {
                if (statusFilter && exp.status !== statusFilter) return false;
                if (categoryFilter && exp.category !== categoryFilter) return false;
                return true;
            });

            displayExpenses();
        }

        function displayExpenses() {
            const container = document.getElementById('expensesList');
            
            if (expenses.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p class="text-slate-500 font-bold">No expenses recorded yet</p>
                        <p class="text-xs text-slate-400 mt-2">Click "Add Expense" to start tracking</p>
                    </div>
                `;
                return;
            }

            const expensesHtml = expenses.map(exp => createExpenseCard(exp)).join('');
            container.innerHTML = expensesHtml;
        }

        function createExpenseCard(expense) {
            const statusColors = {
                'draft': 'bg-slate-100 text-slate-700',
                'pending': 'bg-yellow-100 text-yellow-700',
                'approved': 'bg-green-100 text-green-700',
                'rejected': 'bg-red-100 text-red-700',
                'paid': 'bg-blue-100 text-blue-700',
                'reimbursed': 'bg-purple-100 text-purple-700'
            };

            const categoryNames = {
                'venue': 'Venue Rental',
                'equipment': 'Equipment',
                'catering': 'Catering',
                'decoration': 'Decoration',
                'printing': 'Printing & Stationery',
                'prizes': 'Prizes & Awards',
                'travel': 'Travel & Transportation',
                'marketing': 'Marketing & Promotion',
                'speakers': 'Guest Speakers',
                'miscellaneous': 'Miscellaneous'
            };

            return `
                <div class="border border-[#e5e3da] rounded-sm p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <h3 class="font-bold text-[#1a1c1e] mb-1">${expense.title}</h3>
                            <p class="text-xs text-slate-600 mb-2">${expense.description}</p>
                            <div class="flex flex-wrap gap-2">
                                <span class="text-xs font-bold uppercase tracking-widest ${statusColors[expense.status] || 'bg-slate-100 text-slate-700'} px-2 py-1 rounded-sm">
                                    ${expense.status}
                                </span>
                                <span class="text-xs font-bold text-slate-500 px-2 py-1 bg-slate-100 rounded-sm">
                                    ${categoryNames[expense.category] || expense.category}
                                </span>
                                <span class="text-xs font-bold text-blue-600">
                                    ${expense.expense_id}
                                </span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold text-[#2d4a63]">₹${parseFloat(expense.total_amount).toLocaleString()}</div>
                            ${expense.gst_amount > 0 ? `<div class="text-xs text-slate-500">incl. GST ₹${parseFloat(expense.gst_amount).toFixed(2)}</div>` : ''}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 text-xs text-slate-600 border-t border-[#e5e3da] pt-3">
                        <div><span class="font-bold">Paid To:</span> ${expense.paid_to}</div>
                        ${expense.payment_mode ? `<div><span class="font-bold">Mode:</span> ${expense.payment_mode.toUpperCase()}</div>` : ''}
                        ${expense.payment_date ? `<div><span class="font-bold">Date:</span> ${formatDate(new Date(expense.payment_date))}</div>` : ''}
                        ${expense.invoice_number ? `<div><span class="font-bold">Invoice:</span> ${expense.invoice_number}</div>` : ''}
                    </div>
                    
                    ${expense.notes ? `
                        <div class="mt-3 text-xs text-slate-600 border-t border-[#e5e3da] pt-3">
                            <span class="font-bold">Notes:</span> ${expense.notes}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function switchTab(tab) {
            document.getElementById('ledgerTab').classList.remove('border-b-2', 'border-[#2d4a63]', 'text-[#2d4a63]');
            document.getElementById('addTab').classList.remove('border-b-2', 'border-[#2d4a63]', 'text-[#2d4a63]');
            document.getElementById('ledgerTab').classList.add('text-slate-500');
            document.getElementById('addTab').classList.add('text-slate-500');
            
            document.getElementById('ledgerContent').classList.add('hidden');
            document.getElementById('addContent').classList.add('hidden');

            if (tab === 'ledger') {
                document.getElementById('ledgerTab').classList.add('border-b-2', 'border-[#2d4a63]', 'text-[#2d4a63]');
                document.getElementById('ledgerTab').classList.remove('text-slate-500');
                document.getElementById('ledgerContent').classList.remove('hidden');
            } else {
                document.getElementById('addTab').classList.add('border-b-2', 'border-[#2d4a63]', 'text-[#2d4a63]');
                document.getElementById('addTab').classList.remove('text-slate-500');
                document.getElementById('addContent').classList.remove('hidden');
            }
        }

        function calculateTotal() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const gst = parseFloat(document.getElementById('gstAmount').value) || 0;
            document.getElementById('totalAmount').value = (amount + gst).toFixed(2);
        }

        document.getElementById('expenseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const expenseData = {
                event: eventId,
                category: document.getElementById('category').value,
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                gst_amount: parseFloat(document.getElementById('gstAmount').value) || 0,
                total_amount: parseFloat(document.getElementById('totalAmount').value),
                paid_to: document.getElementById('paidTo').value,
                paid_to_contact: document.getElementById('paidToContact').value,
                payment_mode: document.getElementById('paymentMode').value,
                payment_reference: document.getElementById('paymentReference').value,
                payment_date: document.getElementById('paymentDate').value || null,
                invoice_number: document.getElementById('invoiceNumber').value,
                invoice_date: document.getElementById('invoiceDate').value || null,
                notes: document.getElementById('notes').value,
                status: 'pending'
            };

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`http://localhost:8000/api/auth/events/${eventId}/expenses/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(expenseData)
                });

                if (response.ok) {
                    alert('Expense added successfully!');
                    document.getElementById('expenseForm').reset();
                    switchTab('ledger');
                    await loadExpenses();
                } else {
                    const error = await response.json();
                    alert('Failed to add expense: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding expense:', error);
                alert('Error adding expense');
            }
        });

        function formatDate(date) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
    </script>
</body>
</html>
